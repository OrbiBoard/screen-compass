<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>编辑按钮</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <style>
      :root { --fg: #e6f0ff; --muted: #88a; }
      html, body { height: 100%; }
      body { margin: 0; color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Microsoft YaHei', sans-serif; background: linear-gradient(180deg, rgba(8,16,28,0.72), rgba(12,20,32,0.72)); backdrop-filter: blur(6px); }
      .panel { padding: 12px; border:1px solid rgba(255,255,255,0.2); border-radius:10px; background: rgba(16,24,36,0.85); display:flex; flex-direction:column; gap:8px; }
      .row { display:flex; gap:8px; align-items:center; }
      label { width:120px; flex:0 0 120px; color:#e6f0ff; }
      input, select { height:30px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color:#e6f0ff; padding:0 8px; flex: 1; }
      select, .sel { appearance: none; -webkit-appearance: none; -moz-appearance: none; background: rgba(255,255,255,0.06) !important; color:#e6f0ff !important; border:1px solid rgba(255,255,255,0.2) !important; }
      option { background: #182030; color: #e6f0ff; }
      .actions { display:flex; gap:8px; }
      .btn { height:32px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color:#e6f0ff; cursor:pointer; padding: 0 10px; display:flex; align-items:center; gap:6px; }
      .arg-list { display:flex; flex-direction:column; gap:6px; }
      .arg-item { display:flex; gap:6px; align-items:center; }
      .arg-item input { flex:1; }
      .del { height:30px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color:#e6f0ff; cursor:pointer; }
      #payloadBox > * { margin: 6px 0; }
    </style>
  </head>
  <body>
    <div class="panel">
      <div class="row"><label>名称</label><input id="labelInput" placeholder="名称" /></div>
      <div class="row"><label>图标</label><input id="iconInput" placeholder="ri-focus-3-line" /><button class="btn" id="pickIcon"><i class="ri-pantone-line"></i><span>选择图标</span></button></div>
      <div class="row"><label>类型</label><select id="typeSelect" class="sel"><option value="plugin">插件函数</option><option value="pluginEvent">插件事件</option><option value="openApp">打开程序</option><option value="app">应用</option><option value="cmd">命令</option><option value="power">电源</option></select></div>
      <div id="payloadBox"></div>
      <div class="actions">
        <button class="btn" id="save"><i class="ri-check-line"></i><span>保存</span></button>
        <button class="btn" id="close"><i class="ri-close-line"></i><span>关闭</span></button>
      </div>
    </div>
    <script>
      const scope = 'screen.compass';
      const altScope = 'screen-compass';
      let channelTopic = '';
      let index = 0;
      let items = [];
      let plugins = [];
      let pluginMap = {};
      let remixShort = ['ri-compass-3-line','ri-close-line','ri-shuffle-line','ri-settings-3-line','ri-terminal-line','ri-apps-2-line','ri-focus-3-line','ri-play-line','ri-stop-line','ri-puzzle-line','ri-presentation-line','ri-slideshow-line','ri-pencil-line','ri-brush-line','ri-quill-pen-line','ri-eraser-line'];
      let pluginIcons = [];
      let __iconReqQ = []; let __iconBusy = false; let __synced = false; let __emitTimer = null;
      function emitButtonsUpdate(){ try{ if(__emitTimer) clearTimeout(__emitTimer); __emitTimer = setTimeout(()=>{ try{ const idx=index; const item=items[idx]; if(channelTopic) window.lowbarAPI.emitEvent(channelTopic,{ type:'buttons.update', patch: { index: idx, item } }); }catch{} try{ window.lowbarAPI.pluginCall('screen.compass','broadcastButtons',[{ patch: { index, item: items[index] } }]) }catch{} }, 120); }catch{} }
      function enqueueIcon(path, onDone){ try{ __iconReqQ.push({ path: String(path||''), onDone }); processIconQueue(); }catch{} }
      function processIconQueue(){ if(__iconBusy) return; const job = __iconReqQ.shift(); if(!job) return; __iconBusy = true; (async()=>{ try{ const r = await window.lowbarAPI.pluginCall('screen.compass','getFileIconDataUrl',[job.path]); const url = (r && r.result) ? r.result : r; try{ job.onDone && job.onDone(String(url||'')); }catch{} }catch{} __iconBusy = false; processIconQueue(); })(); }
      function parseQuery(){ try{ const u=new URL(window.location.href); index=Number(u.searchParams.get('index')||0)||0; }catch{ index=0 } }
      async function load(){ try{ const raw=await window.lowbarAPI.configGet(scope,'buttons'); const list=(raw&&raw.result)?raw.result:raw; items=Array.isArray(list)?list:[]; }catch{ items=[] }
        try{ const res=await window.lowbarAPI.pluginCall('screen.compass','listPlugins',[]); const list=(res&&res.result)?res.result:res; plugins=Array.isArray(list)?list:[]; pluginMap={}; plugins.forEach(p=>{ pluginMap[p.id]=p }); pluginIcons=plugins.map(p=>String(p.icon||'').trim()).filter(Boolean); }catch{ plugins=[]; pluginMap={}; pluginIcons=[] }
      }
      function openIconPicker(targetInput){ const overlay=document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(6,12,24,0.6)'; overlay.style.backdropFilter='blur(6px)'; overlay.style.zIndex='9999'; overlay.style.padding='12px'; const panel=document.createElement('div'); panel.style.maxHeight='80vh'; panel.style.overflow='hidden'; panel.style.border='1px solid rgba(255,255,255,0.2)'; panel.style.borderRadius='8px'; panel.style.background='rgba(16,24,36,0.8)'; panel.style.padding='12px'; panel.style.width='min(860px, 92vw)'; panel.style.margin='0 auto'; const close=document.createElement('div'); close.style.textAlign='right'; close.innerHTML='<button class="btn"><i class="ri-close-line"></i><span>关闭</span></button>'; const gridWrap=document.createElement('div'); gridWrap.style.maxHeight='70vh'; gridWrap.style.overflowY='auto'; gridWrap.className='app-grid'; const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fill, 120px)'; grid.style.gap='8px'; const style=document.createElement('style'); style.textContent='.app-grid::-webkit-scrollbar{width:8px}.app-grid::-webkit-scrollbar-thumb{background:rgba(138,180,248,0.4);border-radius:8px}.app-grid::-webkit-scrollbar-track{background:rgba(255,255,255,0.08);border-radius:8px}'; const allIcons=Array.from(new Set([...(pluginIcons||[]), ...remixShort])); allIcons.forEach(ic=>{ const cell=document.createElement('div'); cell.style.display='flex'; cell.style.alignItems='center'; cell.style.gap='8px'; cell.style.cursor='pointer'; cell.style.padding='6px'; cell.style.border='1px solid rgba(255,255,255,0.12)'; cell.style.borderRadius='6px'; cell.innerHTML=`<i class="${ic}"></i><span style="color:#e6f0ff;font-size:12px;">${ic}</span>`; cell.onclick=()=>{ try{ targetInput.value=ic; targetInput.dispatchEvent(new Event('change')); }catch{} document.body.removeChild(overlay); }; grid.appendChild(cell) }); gridWrap.appendChild(grid); panel.appendChild(close); panel.appendChild(gridWrap); overlay.appendChild(style); overlay.appendChild(panel); document.body.appendChild(overlay); const btn=close.querySelector('button'); btn.onclick=()=>{ try{ document.body.removeChild(overlay) }catch{} } }
      function render(){ const it=items[index]||{ label:'', icon:'', actionType:'cmd', actionPayload:{ cmd:'' } }; const label=document.getElementById('labelInput'); const icon=document.getElementById('iconInput'); const type=document.getElementById('typeSelect'); label.value=String(it.label||''); icon.value=String(it.icon||''); type.value=(it.actionType==='program')?'openApp':(it.actionType==='command')?'cmd':(it.actionType||'cmd'); const box=document.getElementById('payloadBox'); renderActionFields(it, box); const sync=()=>{ it.label=label.value; it.icon=icon.value; it.actionType=type.value }; label.onchange=()=>{ sync() }; icon.onchange=()=>{ sync() }; document.getElementById('pickIcon').onclick=()=>openIconPicker(icon); type.onchange=()=>{ sync(); if(type.value==='app'){ try{ label.value='应用'; label.dispatchEvent(new Event('change')); icon.value='ri-apps-2-line'; icon.dispatchEvent(new Event('change')); }catch{} } renderActionFields(it, box) } }
      function renderActionFields(it, box){ box.innerHTML=''; const type=it.actionType||'plugin'; if(type==='plugin'){ const pidSel=document.createElement('select'); pidSel.className='sel'; const emptyOpt=document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='选择插件'; pidSel.appendChild(emptyOpt); plugins.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name||p.id; pidSel.appendChild(opt) }); pidSel.value=(it.actionPayload&&it.actionPayload.pluginId)||''; const actSel=document.createElement('select'); actSel.className='sel'; const emptyAct=document.createElement('option'); emptyAct.value=''; emptyAct.textContent='选择动作(函数)'; actSel.appendChild(emptyAct); const argsList=document.createElement('div'); argsList.className='arg-list'; const addArg=document.createElement('button'); addArg.className='btn'; addArg.innerHTML='<i class="ri-add-line"></i><span>添加参数</span>'; const syncAll=()=>{ const args=Array.from(argsList.querySelectorAll('input')).map(i=>i.value.trim()).filter(s=>s.length); it.actionPayload={ pluginId: pidSel.value.trim(), fn: actSel.value.trim(), args } }; const applyDefaults=()=>{ try{ const info=pluginMap[pidSel.value.trim()]||{}; const acts=Array.isArray(info.actions)?info.actions:[]; const fn=actSel.value.trim(); const picked=acts.find(a=>String(a.target||a.id||'')===fn)||null; const labelEl=document.getElementById('labelInput'); const iconEl=document.getElementById('iconInput'); const nextLabel= picked ? (picked.text||picked.id||fn) : (info.name||pidSel.value.trim()); const nextIcon= String(picked?.icon||info.icon||''); if(labelEl){ labelEl.value=String(nextLabel||''); labelEl.dispatchEvent(new Event('change')); } if(iconEl && nextIcon){ iconEl.value=String(nextIcon); iconEl.dispatchEvent(new Event('change')); } }catch{} }; const updateActions=()=>{ actSel.innerHTML=''; const emptyAct2=document.createElement('option'); emptyAct2.value=''; emptyAct2.textContent='选择动作(函数)'; actSel.appendChild(emptyAct2); const info=pluginMap[pidSel.value.trim()]; const acts=Array.isArray(info?.actions)?info.actions:[]; acts.forEach(a=>{ const opt=document.createElement('option'); opt.value=a.target||a.id||''; opt.textContent=a.text||a.id||(a.target||''); actSel.appendChild(opt) }); const currentFn=(it.actionPayload&&it.actionPayload.fn)||''; if(currentFn && !Array.from(actSel.options).some(o=>o.value===currentFn)){ const opt=document.createElement('option'); opt.value=currentFn; opt.textContent=currentFn+' (自定义)'; actSel.appendChild(opt) } actSel.value=currentFn||''; applyDefaults() }; const buildArgs=()=>{ argsList.innerHTML=''; const src=Array.isArray(it.actionPayload?.args)?it.actionPayload.args:[]; src.forEach((val,index)=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'+(index+1); inp.value=String(val||''); const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll() }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row) }) }; addArg.onclick=()=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'; const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll() }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row) }; pidSel.onchange=()=>{ updateActions(); syncAll() }; actSel.onchange=()=>{ syncAll(); applyDefaults() }; updateActions(); buildArgs(); box.appendChild(pidSel); box.appendChild(actSel); box.appendChild(argsList); box.appendChild(addArg); syncAll() }
        else if(type==='pluginEvent'){ const pidSel=document.createElement('select'); pidSel.className='sel'; const emptyOpt=document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='选择插件'; pidSel.appendChild(emptyOpt); plugins.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name||p.id; pidSel.appendChild(opt) }); pidSel.value=(it.actionPayload&&it.actionPayload.pluginId)||''; const evtSel=document.createElement('select'); evtSel.className='sel'; const emptyEvt=document.createElement('option'); emptyEvt.value=''; emptyEvt.textContent='选择事件'; evtSel.appendChild(emptyEvt); const argsList=document.createElement('div'); argsList.className='arg-list'; const addArg=document.createElement('button'); addArg.className='btn'; addArg.innerHTML='<i class="ri-add-line"></i><span>添加参数</span>'; const syncAll=()=>{ const args=Array.from(argsList.querySelectorAll('input')).map(i=>i.value.trim()).filter(s=>s.length); it.actionPayload={ pluginId: pidSel.value.trim(), event: evtSel.value.trim(), args } }; const applyDefaults=()=>{ try{ const info=pluginMap[pidSel.value.trim()]||{}; const labelEl=document.getElementById('labelInput'); const iconEl=document.getElementById('iconInput'); const evtText = Array.from(evtSel.options).find(o=>o.value===evtSel.value)?.textContent||evtSel.value||''; const nextLabel = evtText ? evtText : (info.name||pidSel.value.trim()); const nextIcon = String(info.icon||''); if(labelEl){ labelEl.value=String(nextLabel||''); labelEl.dispatchEvent(new Event('change')); } if(iconEl && nextIcon){ iconEl.value=String(nextIcon); iconEl.dispatchEvent(new Event('change')); } }catch{} }; const buildArgs=()=>{ argsList.innerHTML=''; const src=Array.isArray(it.actionPayload?.args)?it.actionPayload.args:[]; src.forEach((val,index)=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'+(index+1); inp.value=String(val||''); const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll() }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row) }) }; addArg.onclick=()=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'; const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll() }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row) }; const updateEvents=async()=>{ evtSel.innerHTML=''; const emptyEvt2=document.createElement('option'); emptyEvt2.value=''; emptyEvt2.textContent='选择事件'; evtSel.appendChild(emptyEvt2); try{ const res=await window.lowbarAPI.pluginCall('screen.compass','listAutomationEvents',[pidSel.value.trim()]); const payload=(res&&res.result)?res.result:res; const events=Array.isArray(payload)?payload:[]; events.forEach(e=>{ const opt=document.createElement('option'); opt.value=e.id||e.name; opt.textContent=e.name||e.id; evtSel.appendChild(opt) }) }catch{} const currentEvt=(it.actionPayload&&it.actionPayload.event)||''; if(currentEvt && !Array.from(evtSel.options).some(o=>o.value===currentEvt)){ const opt=document.createElement('option'); opt.value=currentEvt; opt.textContent=currentEvt+' (自定义)'; evtSel.appendChild(opt) } evtSel.value=currentEvt||''; applyDefaults() }; pidSel.onchange=()=>{ updateEvents(); syncAll() }; evtSel.onchange=()=>{ syncAll(); applyDefaults() }; buildArgs(); box.appendChild(pidSel); box.appendChild(evtSel); box.appendChild(argsList); box.appendChild(addArg); updateEvents(); syncAll() }
        else if(type==='openApp'){ const p=document.createElement('input'); p.placeholder='程序路径'; p.value=(it.actionPayload&&it.actionPayload.path)||''; const pick=document.createElement('button'); pick.className='btn'; pick.innerHTML='<i class="ri-apps-2-line"></i><span>选择程序</span>'; const argsList=document.createElement('div'); argsList.className='arg-list'; const addArg=document.createElement('button'); addArg.className='btn'; addArg.innerHTML='<i class="ri-add-line"></i><span>添加参数</span>'; const sync=()=>{ const args=Array.from(argsList.querySelectorAll('input')).map(i=>i.value.trim()).filter(s=>s.length); it.actionPayload={ path: p.value.trim(), args } }; const buildArgs=()=>{ argsList.innerHTML=''; const src=Array.isArray(it.actionPayload?.args)?it.actionPayload.args:[]; src.forEach((val,index)=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'+(index+1); inp.value=String(val||''); const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); sync() }; inp.onchange=sync; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row) }) }; addArg.onclick=()=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'; const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); sync() }; inp.onchange=sync; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row) }; pick.onclick=()=>{ try{ openAppSelectorLazy(p) }catch{} };
          box.appendChild(p); box.appendChild(pick); box.appendChild(argsList); box.appendChild(addArg); p.onchange=sync; buildArgs(); sync() }
        else if(type==='app'){ try{ const labelEl=document.getElementById('labelInput'); const iconEl=document.getElementById('iconInput'); if(labelEl){ labelEl.value='应用'; labelEl.dispatchEvent(new Event('change')); } if(iconEl){ iconEl.value='ri-apps-2-line'; iconEl.dispatchEvent(new Event('change')); } }catch{} const hint=document.createElement('div'); hint.style.color='var(--muted)'; hint.textContent='点击该按钮将打开“应用”悬浮窗（显示插件列表）'; box.appendChild(hint); it.actionPayload={}; }
        else if(type==='cmd'){ const c=document.createElement('input'); c.placeholder='命令'; c.value=(it.actionPayload&&it.actionPayload.cmd)||''; const sync=()=>{ it.actionPayload={ cmd: c.value } }; c.onchange=sync; box.appendChild(c) }
        else if(type==='power'){ const opSel=document.createElement('select'); opSel.className='sel'; ['shutdown','restart','logoff'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; opSel.appendChild(opt) }); opSel.value=(it.actionPayload&&it.actionPayload.op)||'shutdown'; const sync=()=>{ it.actionPayload={ op: opSel.value } }; opSel.onchange=sync; box.appendChild(opSel) }
      }
      async function save(){ try{ await window.lowbarAPI.configSet(scope,'buttons',items); try{ await window.lowbarAPI.configSet(altScope,'buttons',items) }catch{} try{ if(channelTopic) await window.lowbarAPI.emitEvent(channelTopic,{ type:'buttons.update', buttons: items }); }catch{} }catch{} try{ await window.lowbarAPI.pluginCall('screen.compass','broadcastButtons',[{ buttons: items }]) }catch{} try{ await window.lowbarAPI.pluginCall('screen.compass','closeItemEditor',[]) }catch{} }

      function openAppSelectorLazy(pInput){ (async()=>{
        try{
          const res=await window.lowbarAPI.pluginCall('screen.compass','listInstalledApps',[]);
          const payload=(res&&res.result)?res.result:res;
          const apps=Array.isArray(payload)?payload:[];
          const overlay=document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(6,12,24,0.6)'; overlay.style.backdropFilter='blur(6px)'; overlay.style.zIndex='9999'; overlay.style.padding='12px';
          const panel=document.createElement('div'); panel.className='app-panel'; panel.style.maxHeight='80vh'; panel.style.overflow='hidden'; panel.style.border='1px solid rgba(255,255,255,0.2)'; panel.style.borderRadius='8px'; panel.style.background='rgba(16,24,36,0.85)'; panel.style.padding='12px'; panel.style.width='min(900px, 94vw)'; panel.style.margin='0 auto';
          const close=document.createElement('div'); close.style.display='flex'; close.style.justifyContent='space-between'; close.style.alignItems='center';
          const title=document.createElement('div'); title.innerHTML='<span style="color:#e6f0ff;">选择程序（开始菜单）</span>';
          const closeBtn=document.createElement('button'); closeBtn.className='btn'; closeBtn.innerHTML='<i class="ri-close-line"></i><span>关闭</span>';
          close.appendChild(title); close.appendChild(closeBtn);
          const search=document.createElement('input'); search.placeholder='搜索程序...'; search.style.margin='8px 0';
          const gridWrap=document.createElement('div'); gridWrap.style.maxHeight='65vh'; gridWrap.style.overflowY='auto'; gridWrap.className='app-grid';
          const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fill, minmax(300px, 1fr))'; grid.style.gap='8px';
          const style=document.createElement('style'); style.textContent='.app-grid::-webkit-scrollbar{width:8px}.app-grid::-webkit-scrollbar-thumb{background:rgba(138,180,248,0.4);border-radius:8px}.app-grid::-webkit-scrollbar-track{background:rgba(255,255,255,0.08);border-radius:8px}.app-panel .cell{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid rgba(255,255,255,0.12);border-radius:6px}.app-panel .cell .left{display:flex;align-items:center;gap:8px;min-width:0}.app-panel .cell .left .name{color:#e6f0ff}';

          

          

          const renderApps=(q)=>{
            grid.innerHTML='';
            const kw=String(q||'').toLowerCase();
            apps.filter(a=>{ const nm=String(a.name||'').toLowerCase(); const pt=String(a.path||'').toLowerCase(); return !kw || nm.includes(kw) || pt.includes(kw) }).forEach((a)=>{
              const cell=document.createElement('div'); cell.className='cell';
              const left=document.createElement('div'); left.className='left';
              const nm=document.createElement('div'); nm.className='name'; nm.textContent=a.name||'';
              left.appendChild(nm);
              const choose=document.createElement('button'); choose.className='btn'; choose.innerHTML='<i class="ri-check-line"></i><span>选择</span>';
              choose.onclick=()=>{
                pInput.value=String(a.path||''); pInput.dispatchEvent(new Event('change'));
                enqueueIcon(String(a.path||''), (url)=>{ const inIcon=document.getElementById('iconInput'); const inLabel=document.getElementById('labelInput'); try{ if(inIcon && url){ inIcon.value=String(url); inIcon.dispatchEvent(new Event('change')); } if(inLabel){ inLabel.value=String(a.name||''); inLabel.dispatchEvent(new Event('change')); } }catch{} });
                try{ document.body.removeChild(overlay) }catch{}
              };
              cell.appendChild(left); cell.appendChild(choose); grid.appendChild(cell);
            });
          };

          search.oninput=()=>renderApps(search.value);
          renderApps('');

          panel.appendChild(close); panel.appendChild(search);
          gridWrap.appendChild(grid); panel.appendChild(gridWrap);
          overlay.appendChild(style); overlay.appendChild(panel);
          document.body.appendChild(overlay);
          closeBtn.onclick=()=>{ try{ document.body.removeChild(overlay) }catch{} };
        }catch{}
      })() }
      function openAppSelector(pInput){ (async()=>{ try{ const res=await window.lowbarAPI.pluginCall('screen.compass','listInstalledApps',[]); const payload=(res&&res.result)?res.result:res; const apps=Array.isArray(payload)?payload:[]; const overlay=document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(6,12,24,0.6)'; overlay.style.backdropFilter='blur(6px)'; overlay.style.zIndex='9999'; overlay.style.padding='12px'; const panel=document.createElement('div'); panel.className='app-panel'; panel.style.maxHeight='80vh'; panel.style.overflow='hidden'; panel.style.border='1px solid rgba(255,255,255,0.2)'; panel.style.borderRadius='8px'; panel.style.background='rgba(16,24,36,0.85)'; panel.style.padding='12px'; panel.style.width='min(900px, 94vw)'; panel.style.margin='0 auto'; const close=document.createElement('div'); close.style.display='flex'; close.style.justifyContent='space-between'; close.style.alignItems='center'; const title=document.createElement('div'); title.innerHTML='<span style="color:#e6f0ff;">选择程序（开始菜单）</span>'; const closeBtn=document.createElement('button'); closeBtn.className='btn'; closeBtn.innerHTML='<i class="ri-close-line"></i><span>关闭</span>'; close.appendChild(title); close.appendChild(closeBtn); const search=document.createElement('input'); search.placeholder='搜索程序...'; search.style.margin='8px 0'; const gridWrap=document.createElement('div'); gridWrap.style.maxHeight='65vh'; gridWrap.style.overflowY='auto'; gridWrap.className='app-grid'; const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fill, minmax(300px, 1fr))'; grid.style.gap='8px'; const style=document.createElement('style'); style.textContent='.app-grid::-webkit-scrollbar{width:8px}.app-grid::-webkit-scrollbar-thumb{background:rgba(138,180,248,0.4);border-radius:8px}.app-grid::-webkit-scrollbar-track{background:rgba(255,255,255,0.08);border-radius:8px}.app-panel .cell{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid rgba(255,255,255,0.12);border-radius:6px}.app-panel .cell .left{display:flex;align-items:center;gap:8px;min-width:0}.app-panel .cell .left img{width:20px;height:20px;border-radius:4px;object-fit:contain}.app-panel .cell .left .name{color:#e6f0ff}'; const renderApps=(q)=>{ grid.innerHTML=''; const kw=String(q||'').toLowerCase(); apps.filter(a=>{ const nm=String(a.name||'').toLowerCase(); const pt=String(a.path||'').toLowerCase(); return !kw || nm.includes(kw) || pt.includes(kw) }).forEach(async(a)=>{ const cell=document.createElement('div'); cell.className='cell'; const left=document.createElement('div'); left.className='left'; const icon=document.createElement('img'); const nm=document.createElement('div'); nm.className='name'; nm.textContent=a.name||''; const isShortcut=String(a.path||'').toLowerCase().endsWith('.lnk'); const scIcon=document.createElement('i'); scIcon.className=isShortcut?'ri-links-line':'ri-apps-2-line'; left.appendChild(icon); left.appendChild(scIcon); left.appendChild(nm); const choose=document.createElement('button'); choose.className='btn'; choose.innerHTML='<i class="ri-check-line"></i><span>选择</span>'; choose.onclick=async()=>{ pInput.value=String(a.path||''); pInput.dispatchEvent(new Event('change')); try{ const rIcon=await window.lowbarAPI.pluginCall('screen.compass','getFileIconDataUrl',[String(a.path||'')]); const url=(rIcon&&rIcon.result)?rIcon.result:rIcon; const inIcon=document.getElementById('iconInput'); const inLabel=document.getElementById('labelInput'); if(inIcon && url){ inIcon.value=String(url); inIcon.dispatchEvent(new Event('change')); } if(inLabel){ inLabel.value=String(a.name||''); inLabel.dispatchEvent(new Event('change')); } }catch{} try{ document.body.removeChild(overlay) }catch{} }; cell.appendChild(left); cell.appendChild(choose); grid.appendChild(cell); try{ const rIcon=await window.lowbarAPI.pluginCall('screen.compass','getFileIconDataUrl',[String(a.path||'')]); const url=(rIcon&&rIcon.result)?rIcon.result:rIcon; icon.src=String(url||'') }catch{ icon.src='' } }) }; search.oninput=()=>renderApps(search.value); renderApps(''); panel.appendChild(close); panel.appendChild(search); gridWrap.appendChild(grid); panel.appendChild(gridWrap); overlay.appendChild(style); overlay.appendChild(panel); document.body.appendChild(overlay); closeBtn.onclick=()=>{ try{ document.body.removeChild(overlay) }catch{} } }catch{} })() }
      (async function(){ parseQuery(); try{ const u=new URL(window.location.href); channelTopic=String(u.searchParams.get('channel')||''); }catch{} await load(); render(); try{ if(channelTopic){ window.lowbarAPI.subscribe?.(channelTopic); window.lowbarAPI.onEvent?.((n,p)=>{ if(n!==channelTopic) return; if(p && p.type==='buttons.update'){ try{ if(Array.isArray(p.buttons)) items = p.buttons; __synced = true; render(); }catch{} } }); } }catch{} document.getElementById('save').onclick=save; document.getElementById('close').onclick=async()=>{ try{ await window.lowbarAPI.pluginCall('screen.compass','closeItemEditor',[]) }catch{} }; document.addEventListener('click',(e)=>{ try{ const el=e.target; if(el && el.closest && el.closest('button') && (el.closest('button').innerText||'').includes('选择程序')){ const btn=el.closest('button'); const row=btn.closest('.row'); const inp=row?row.querySelector('input'):null; if(inp){ e.preventDefault(); e.stopPropagation(); openAppSelectorLazy(inp); } } }catch{} }, true); })();
    </script>
  </body>
</html>

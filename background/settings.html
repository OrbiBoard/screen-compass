<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>屏幕罗盘设置</title>
    <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
    <style>
       :root { --fg: #e6f0ff; --muted: #88a; }
      html, body { height: 100%; }
      body { margin: 0; background: transparent; color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Microsoft YaHei', sans-serif; }
      .wrap { padding: 12px; max-height: 92vh; height: auto; box-sizing: border-box; overflow: hidden; }
      .split { display:flex; gap:12px; height: auto; min-height: 0; }
      .left-pane { flex: 0 0 340px; display:flex; align-items:center; justify-content:center; height: auto; background: rgba(16,24,36,0.32); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; box-shadow: inset 0 8px 24px rgba(0,0,0,0.35), 0 6px 18px rgba(0,0,0,0.35); padding: 10px; }
      .right-pane { flex: 1 1 auto; max-height: 92vh; overflow-y: auto; background: rgba(16,24,36,0.18); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.35); padding: 10px; }
      .title { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
      .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
      .row.active { background: rgba(138,180,248,0.12); outline: 2px solid rgba(138,180,248,0.35); border-radius: 8px; }
      input, select { height:30px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color:#e6f0ff; padding:0 8px; }
      select, .sel { appearance: none; -webkit-appearance: none; -moz-appearance: none; background: rgba(255,255,255,0.06) !important; color:#e6f0ff !important; border:1px solid rgba(255,255,255,0.2) !important; }
      option { background: #182030; color: #e6f0ff; }
      .del { margin-left:auto; height:30px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color:#e6f0ff; cursor:pointer; }
      .actions { display:flex; gap:8px; margin-top:10px; }
      .btn { height:32px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color:#e6f0ff; cursor:pointer; padding: 0 10px; display:flex; align-items:center; gap:6px; }
      .btn.primary { border-color: rgba(64,224,128,0.4); background: rgba(64,224,128,0.18); }
      .arg-list { display:flex; flex-direction:column; gap:6px; }
      .arg-item { display:flex; gap:6px; align-items:center; }
      .arg-item input { flex:1; }
      .arg-item .del { height:30px; }
      .seg { display:flex; gap:6px; }
      .seg .btn { height:30px; padding:0 12px; }
      .seg .btn.active { border-color: rgba(64,128,255,0.42); background: rgba(64,128,255,0.22); }
      .badge { display:inline-flex; align-items:center; gap:6px; padding: 2px 10px; border-radius: 999px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); font-size: 12px; }
      .pane-row { display:flex; gap:12px; align-items:flex-start; margin-top:12px; }
      .preview { border:1px solid rgba(255,255,255,0.2); border-radius:10px; background: linear-gradient(180deg, rgba(40,80,120,0.25), rgba(20,30,50,0.25)); width: 200px; height: 200px; display:flex; align-items:center; justify-content:center; position: relative; overflow:hidden; box-shadow: 0 10px 24px rgba(0,0,0,0.35); }
      .preview .root { width:100%; height:100%; position:relative; display:flex; align-items:center; justify-content:center; }
      .preview .circle-bg { position:absolute; inset:0; border-radius:50%; background: rgba(20,28,40,0.28); border: 1px solid rgba(255,255,255,0.18); }
      .preview .ring { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
      .preview .sectors { position:absolute; inset:0; pointer-events:none; }
      .preview .wedge { transition: opacity .2s ease; }
      .preview .item { width: 44px; height: 58px; border-radius: 12px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; background: rgba(20,28,40,0.52); border: 1px solid rgba(255,255,255,0.28); pointer-events:auto; cursor:pointer; }
      .preview .item i { font-size:22px; color:#e6f0ff; }
      .preview .item .label { font-size:11px; line-height:12px; color:#e6f0ff; opacity:0.88; max-width:64px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .preview .center-btn { width: 50px; height: 50px; border-radius: 50%; display:flex; align-items:center; justify-content:center; background: rgba(20,28,40,0.62); border: 1px solid rgba(255,255,255,0.30); cursor: pointer; position: relative; z-index: 3; }
      .preview .center-btn i { font-size: 22px; color: #ffffff; }
      .preview.classic .item { background: transparent; border: none; height: 58px; width: 56px; }
      .preview.classic .item .dot { width: 52px; height: 52px; border-radius: 50%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:3px; background: rgba(20,28,40,0.62); border: 1px solid rgba(255,255,255,0.30); }
      .preview.classic .item i { color:#ffffff; font-size: 19px; }
      .preview.classic .item .label { font-size: 11px; line-height: 12px; max-width: 48px; margin: 0; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .preview.sector .circle-bg { opacity: 1; }
      .preview.classic .circle-bg { opacity: 0; }
      .preview.sector .item { background: transparent; border: none; }
      .preview.classic .item.active .dot { border-color: rgba(64,128,255,0.42); box-shadow: 0 0 0 2px rgba(64,128,255,0.22) inset; }
      .editor { border:1px solid rgba(255,255,255,0.2); border-radius:10px; background: rgba(16,24,36,0.35); padding:10px; display:flex; flex-direction:column; gap:8px; margin-top: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
      #appearanceEditor { margin-top: 0; width: auto; flex: 1 1 auto; position: static; top: auto; }
      .editor .row { margin: 0; }
      #appearanceEditor .row label { flex: 0 0 120px; }
      #appearanceEditor .row input { flex: 1 1 auto; min-width: 0; }
      #appearanceEditor .row .btn { flex: 0 0 auto; min-width: 120px; height: 30px; padding: 0 12px; white-space: nowrap; }
      .pane { margin-bottom: 16px; }
      .center.area { position: fixed; left: 0; right: 0; bottom: 8px; display: flex; justify-content: center; pointer-events: none; }
      .center.area .wrap { pointer-events: auto; background: rgba(16,24,36,0.55); border: 1px solid rgba(255,255,255,0.16); border-radius: 12px; padding: 6px 8px; }
      .center.area .items { display: flex; gap: 8px; }
      .center.area .items .btn { height: 28px; padding: 0 10px; }
      .center.area .items .btn.active { border-color: rgba(64,128,255,0.42); background: rgba(64,128,255,0.22); }
      .num { display:flex; align-items:center; gap:6px; flex: 1 1 auto; }
      .btn.step { height: 30px; width: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
      .actions { background: rgba(16,24,36,0.25); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 8px; }

    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="split">
        <div class="left-pane" id="leftPane">
          <div class="preview" id="preview">
            <div class="root" id="pvRoot">
              <div class="circle-bg" id="pvCircle"></div>
              <div class="sectors" id="pvSectors"></div>
              <div class="ring" id="pvRing"></div>
              <div id="pvHTray" style="position:absolute;display:none;height:58px;align-items:center;gap:8px;padding:6px 8px;"></div>
              <div class="center-btn" id="pvCenter"><i class="ri-compass-3-line"></i></div>
            </div>
          </div>
        </div>
        <div class="right-pane">
          <div id="paneTheme" class="pane" style="display:none;">
            <div class="title"><i class="ri-pantone-line"></i> 外观与主题</div>
            <div class="editor" id="appearanceEditor">
              <div class="row"><label style="min-width:120px;color:#e6f0ff;">收起窗口尺寸</label><div class="num"><button class="btn step" id="sizeCollapsedDec"><i class="ri-subtract-line"></i></button><input id="sizeCollapsedInput" type="number" min="40" max="240" step="1" placeholder="60" /><button class="btn step" id="sizeCollapsedInc"><i class="ri-add-line"></i></button></div></div>
              <div class="row"><label style="min-width:120px;color:#e6f0ff;">展开窗口尺寸</label><div class="num"><button class="btn step" id="sizeExpandedDec"><i class="ri-subtract-line"></i></button><input id="sizeExpandedInput" type="number" min="120" max="480" step="1" placeholder="240" /><button class="btn step" id="sizeExpandedInc"><i class="ri-add-line"></i></button></div></div>
              <div class="row"><label style="min-width:120px;color:#e6f0ff;">中心按钮大小</label><div class="num"><button class="btn step" id="centerSizeDec"><i class="ri-subtract-line"></i></button><input id="centerSizeInput" type="number" min="32" max="160" step="1" placeholder="50" /><button class="btn step" id="centerSizeInc"><i class="ri-add-line"></i></button></div></div>
              <div class="row"><label style="min-width:120px;color:#e6f0ff;">罗盘图标</label><input id="centerIconInput" placeholder="ri-compass-3-line" /><button class="btn" id="pickCenterIcon"><i class="ri-pantone-line"></i><span>选择图标</span></button></div>
            <div class="row"><label style="min-width:80px;color:#e6f0ff;">主题</label><div class="seg" id="themeSeg"><button class="btn" id="themeClassicBtn"><span>经典</span></button><button class="btn" id="themeSectorBtn"><span>扇形</span></button><button class="btn" id="themeHLeftBtn"><span>横向(左)</span></button><button class="btn" id="themeHRightBtn"><span>横向(右)</span></button></div></div>
            </div>
          </div>
          <div id="paneProject" class="pane" style="display:none;">
            <div class="title"><i class="ri-list-check"></i> 项目与动作</div>
            <div id="pvTopTrayWrap" style="display:none; position:relative; margin:12px 0 14px 0; padding: 2px 0;">
              <div id="pvTopTrayBg" style="position:absolute; left:12px; right:12px; top:0; height:72px; border-radius:54px; border:1px solid rgba(255,255,255,0.28); background: rgba(20,28,40,0.52);"></div>
              <div id="pvTopTray" style="position:relative; display:none; height:60px; align-items:center; gap:10px; padding:6px 12px;"></div>
            </div>
            <div id="projectList"></div>
          </div>
          <div class="actions">
            <button class="btn" id="add"><i class="ri-add-line"></i><span>新增按钮</span></button>
            <button class="btn primary" id="save"><i class="ri-check-line"></i><span>保存</span></button>
          </div>
        </div>
      </div>
    </div>
    <script>
      const scope = 'screen.compass';
      const altScope = 'screen-compass';
      let channelTopic = '';
      let items = [];
      let pluginIcons = [];
      const remixShort = ['ri-compass-3-line','ri-close-line','ri-shuffle-line','ri-settings-3-line','ri-terminal-line','ri-apps-2-line','ri-focus-3-line','ri-play-line','ri-stop-line','ri-puzzle-line','ri-presentation-line','ri-slideshow-line','ri-pencil-line','ri-brush-line','ri-quill-pen-line','ri-eraser-line'];
      let plugins = [];
      let pluginMap = {};
      async function ensureDefaults(){
        const defaults = {
          buttons: [
            { id: 'rollcall', label: '随机点名', icon: 'ri-shuffle-line', actionType: 'plugin', actionPayload: { pluginId: 'rollcall.random', fn: 'openRollcallTemplate', args: [] } }
          ]
        };
        try { await window.lowbarAPI.configEnsureDefaults(scope, defaults); } catch {}
      }
      async function load(){
        try {
          let raw = await window.lowbarAPI.configGet(scope, 'buttons');
          const list = (raw && raw.result) ? raw.result : raw;
          items = Array.isArray(list) ? list : [];
          if (!items.length) { try { raw = await window.lowbarAPI.configGet(altScope, 'buttons'); const list2 = (raw && raw.result) ? raw.result : raw; items = Array.isArray(list2) ? list2 : items; } catch {} }
          items.forEach(it => { if (it && typeof it==='object') { if (it.actionType==='program') it.actionType='openApp'; if (it.actionType==='command') it.actionType='cmd'; } });
        } catch { items = []; }
        try { let v = await window.lowbarAPI.configGet(scope, 'sizeCollapsed'); window.__sizeCollapsed = Number((v && v.result) ? v.result : v) || 60; if (!v) { try { v = await window.lowbarAPI.configGet(altScope, 'sizeCollapsed'); window.__sizeCollapsed = Number((v && v.result) ? v.result : v) || window.__sizeCollapsed; } catch {} } } catch { window.__sizeCollapsed = 60; }
        try { let v = await window.lowbarAPI.configGet(scope, 'sizeExpanded'); window.__sizeExpanded = Number((v && v.result) ? v.result : v) || 240; if (!v) { try { v = await window.lowbarAPI.configGet(altScope, 'sizeExpanded'); window.__sizeExpanded = Number((v && v.result) ? v.result : v) || window.__sizeExpanded; } catch {} } } catch { window.__sizeExpanded = 240; }
        try { let v = await window.lowbarAPI.configGet(scope, 'centerSize'); window.__centerSize = Number((v && v.result) ? v.result : v) || 50; if (!v) { try { v = await window.lowbarAPI.configGet(altScope, 'centerSize'); window.__centerSize = Number((v && v.result) ? v.result : v) || window.__centerSize; } catch {} } } catch { window.__centerSize = 50; }
        try { let v = await window.lowbarAPI.configGet(scope, 'centerIcon'); window.__centerIcon = String((v && v.result) ? v.result : v || 'ri-compass-3-line'); if (!v) { try { v = await window.lowbarAPI.configGet(altScope, 'centerIcon'); const vv = (v && v.result) ? v.result : v; window.__centerIcon = String(vv || window.__centerIcon || 'ri-compass-3-line'); } catch {} } } catch { window.__centerIcon = 'ri-compass-3-line'; }
        try {
          window.__centerSize = Math.max(32, Math.min(160, Number(window.__centerSize || 50)));
          window.__sizeCollapsed = Math.max(40, Math.min(240, Number(window.__sizeCollapsed || (window.__centerSize + 10))));
          window.__centerSize = Math.max(32, Math.min(160, Number(window.__sizeCollapsed - 10)));
          window.__sizeCollapsed = Math.max(40, Math.min(240, Number(window.__centerSize + 10)));
        } catch {}
      }
      function render(){ renderProjectList(); }
      function renderProjectList(){
        const root = document.getElementById('projectList');
        root.innerHTML = '';
        const listWrap = document.createElement('div'); listWrap.className='editor';
        if (!Array.isArray(items) || items.length === 0) { root.appendChild(listWrap); return; }
        const ul = document.createElement('div'); ul.style.display='flex'; ul.style.flexDirection='column'; ul.style.gap='8px';
        const typeLabel = (t)=>{
          const m = { plugin:'插件函数', pluginEvent:'插件事件', openApp:'打开程序', cmd:'命令', power:'电源' };
          const k = (t==='program')?'openApp':(t==='command')?'cmd':t; return m[k]||String(k||'');
        };
        items.forEach((it, i)=>{
          const row = document.createElement('div'); row.className='row';
          const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px'; left.style.flex='1';
          let iconEl;
          try {
            const ic = String(it.icon||'');
            if (ic.startsWith('ri-')) { iconEl = document.createElement('i'); iconEl.className = ic; }
            else { iconEl = document.createElement('img'); iconEl.src = ic; iconEl.style.width='18px'; iconEl.style.height='18px'; iconEl.style.objectFit='contain'; iconEl.style.borderRadius='4px'; }
          } catch { iconEl = document.createElement('i'); iconEl.className='ri-circle-line'; }
          const labelEl = document.createElement('span'); labelEl.textContent = String(it.label||''); labelEl.style.color='#e6f0ff';
          const typeBadge = document.createElement('span'); typeBadge.className='badge'; typeBadge.innerHTML = `<i class="ri-tools-line"></i> ${typeLabel(it.actionType)}`;
          left.appendChild(iconEl); left.appendChild(labelEl);
          left.appendChild(typeBadge);
          const btnUp = document.createElement('button'); btnUp.className='btn'; btnUp.innerHTML='<i class="ri-arrow-up-line"></i><span>上移</span>';
          const btnDown = document.createElement('button'); btnDown.className='btn'; btnDown.innerHTML='<i class="ri-arrow-down-line"></i><span>下移</span>';
          const btnEdit = document.createElement('button'); btnEdit.className='btn'; btnEdit.innerHTML='<i class="ri-edit-line"></i><span>编辑</span>';
          const btnDel = document.createElement('button'); btnDel.className='del'; btnDel.textContent='删除';
          btnUp.onclick = () => { if (i>0){ const tmp = items[i-1]; items[i-1]=items[i]; items[i]=tmp; window.__selectedIndex = i-1; renderProjectList(); placePreview(); } };
          btnDown.onclick = () => { if (i<items.length-1){ const tmp = items[i+1]; items[i+1]=items[i]; items[i]=tmp; window.__selectedIndex = i+1; renderProjectList(); placePreview(); } };
          btnEdit.onclick = async () => { try { await window.lowbarAPI.pluginCall('screen.compass','openItemEditor',[i]); } catch {} try { await window.lowbarAPI.pluginCall('screen.compass','broadcastButtons',[{ buttons: items, theme, sizeCollapsed: window.__sizeCollapsed, sizeExpanded: window.__sizeExpanded, centerSize: window.__centerSize, centerIcon: window.__centerIcon }]); } catch {} };
          btnDel.onclick = () => { items.splice(i,1); if (typeof window.__selectedIndex!=='number' || window.__selectedIndex>=items.length) window.__selectedIndex = items.length-1; renderProjectList(); placePreview(); };
          row.appendChild(left); row.appendChild(btnUp); row.appendChild(btnDown); row.appendChild(btnEdit); row.appendChild(btnDel);
          row.onclick = () => { window.__selectedIndex = i; placePreview(); renderProjectList(); };
          if (typeof window.__selectedIndex==='number' && window.__selectedIndex===i) row.classList.add('active');
          ul.appendChild(row);
        });
        listWrap.appendChild(ul); root.appendChild(listWrap);
      }
      document.getElementById('add').onclick = async () => { items.push({ id: 'btn_'+Date.now(), label:'新按钮', icon:'ri-focus-3-line', actionType:'cmd', actionPayload:{ cmd: '' } }); window.__selectedIndex = items.length - 1; renderProjectList(); placePreview(); try { await window.lowbarAPI.configSet(scope, 'buttons', items); } catch {} try { await window.lowbarAPI.configSet(altScope, 'buttons', items); } catch {} try { if (channelTopic) await window.lowbarAPI.emitEvent(channelTopic, { type: 'buttons.update', buttons: items }); } catch {} try { await window.lowbarAPI.pluginCall('screen.compass','broadcastButtons',[{ buttons: items }]); } catch {} };
      let theme = 'classic';
      function updateThemeSeg(){ try {
        const c = document.getElementById('themeClassicBtn');
        const s = document.getElementById('themeSectorBtn');
        const hl = document.getElementById('themeHLeftBtn');
        const hr = document.getElementById('themeHRightBtn');
        c.classList.toggle('active', theme==='classic');
        s.classList.toggle('active', theme==='sector');
        hl.classList.toggle('active', theme==='hleft');
        hr.classList.toggle('active', theme==='hright');
        const lp = document.getElementById('leftPane');
        if (lp) lp.style.display = (theme==='hleft' || theme==='hright') ? 'none' : 'flex';
      } catch {} }
      document.getElementById('themeClassicBtn').onclick = () => { theme = 'classic'; updateThemeSeg(); placePreview(); };
      document.getElementById('themeSectorBtn').onclick = () => { theme = 'sector'; updateThemeSeg(); placePreview(); };
      document.getElementById('themeHLeftBtn').onclick = () => { theme = 'hleft'; updateThemeSeg(); placePreview(); };
      document.getElementById('themeHRightBtn').onclick = () => { theme = 'hright'; updateThemeSeg(); placePreview(); };
      document.getElementById('save').onclick = async () => {
        try {
          await window.lowbarAPI.configSet(scope, 'theme', theme);
          await window.lowbarAPI.configSet(scope, 'buttons', items);
          await window.lowbarAPI.configSet(scope, 'sizeCollapsed', Math.max(40, Math.min(240, Number(document.getElementById('sizeCollapsedInput').value || window.__sizeCollapsed || 60))));
          await window.lowbarAPI.configSet(scope, 'sizeExpanded', Math.max(120, Math.min(480, Number(document.getElementById('sizeExpandedInput').value || window.__sizeExpanded || 240))));
          const centerSaved = Math.max(32, Math.min(160, Number(document.getElementById('centerSizeInput').value || window.__centerSize || 50)));
          window.__centerSize = centerSaved;
          window.__sizeCollapsed = Math.max(40, Math.min(240, centerSaved + 10));
          await window.lowbarAPI.configSet(scope, 'centerSize', window.__centerSize);
          window.__centerIcon = String(document.getElementById('centerIconInput').value || window.__centerIcon || 'ri-compass-3-line');
          await window.lowbarAPI.configSet(scope, 'centerIcon', window.__centerIcon);
          try {
            await window.lowbarAPI.configSet(altScope, 'theme', theme);
            await window.lowbarAPI.configSet(altScope, 'buttons', items);
            await window.lowbarAPI.configSet(altScope, 'sizeCollapsed', window.__sizeCollapsed);
            await window.lowbarAPI.configSet(altScope, 'sizeExpanded', window.__sizeExpanded);
            await window.lowbarAPI.configSet(altScope, 'centerSize', window.__centerSize);
            await window.lowbarAPI.configSet(altScope, 'centerIcon', window.__centerIcon);
          } catch {}
          try { if (channelTopic) await window.lowbarAPI.emitEvent(channelTopic, { type: 'buttons.update', buttons: items, theme, sizeCollapsed: window.__sizeCollapsed, sizeExpanded: window.__sizeExpanded, centerSize: window.__centerSize, centerIcon: window.__centerIcon }); } catch {}
          try { await window.lowbarAPI.pluginCall('screen.compass','broadcastButtons',[{ buttons: items, theme, sizeCollapsed: window.__sizeCollapsed, sizeExpanded: window.__sizeExpanded, centerSize: window.__centerSize, centerIcon: window.__centerIcon }]); } catch {}
        } catch {}
      };
      function placePreview(){
        try { const rootEl = document.getElementById('pvRoot'); const ring = document.getElementById('pvRing'); ring.innerHTML=''; const sectors = document.getElementById('pvSectors'); sectors.innerHTML=''; const hTray = document.getElementById('pvHTray'); hTray.innerHTML=''; } catch {}
        const rootEl = document.getElementById('pvRoot'); const ring = document.getElementById('pvRing'); const sectors = document.getElementById('pvSectors'); const hTray = document.getElementById('pvHTray');
        const W = Math.max(200, Math.floor(rootEl.getBoundingClientRect().width || 240));
        const H = Math.max(200, Math.floor(rootEl.getBoundingClientRect().height || 240));
        const cx = Math.floor(W/2), cy = Math.floor(H/2);
        let R = Math.min(cx, cy) - 24; if (R < 22) R = 22;
        const N = items.length;
        try { const pv = document.getElementById('preview'); pv.classList.toggle('classic', theme==='classic'); pv.classList.toggle('sector', theme==='sector'); } catch {}
        if (theme === 'sector' && N > 0) {
          const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
          svg.setAttribute('width','100%');
          svg.setAttribute('height','100%');
          svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
          const ro = Math.min(R + 14, Math.min(cx, cy) - 10);
          const centerR = 25;
          const ri = Math.max(centerR + 4, Math.round(R * 0.5));
          for (let i = 0; i < N; i++) {
            const a1 = (Math.PI * 2) * (i / N);
            const a2 = (Math.PI * 2) * ((i + 1) / N);
            const o1x = Math.round(cx + ro * Math.cos(a1));
            const o1y = Math.round(cy + ro * Math.sin(a1));
            const o2x = Math.round(cx + ro * Math.cos(a2));
            const o2y = Math.round(cy + ro * Math.sin(a2));
            const i2x = Math.round(cx + ri * Math.cos(a2));
            const i2y = Math.round(cy + ri * Math.sin(a2));
            const i1x = Math.round(cx + ri * Math.cos(a1));
            const i1y = Math.round(cy + ri * Math.sin(a1));
            const largeArc = ((a2 - a1) % (Math.PI*2)) > Math.PI ? 1 : 0;
            const path = document.createElementNS('http://www.w3.org/2000/svg','path');
            const d = `M ${o1x} ${o1y} A ${ro} ${ro} 0 ${largeArc} 1 ${o2x} ${o2y} L ${i2x} ${i2y} A ${ri} ${ri} 0 ${largeArc} 0 ${i1x} ${i1y} Z`;
            path.setAttribute('d', d);
            path.setAttribute('fill','rgba(64,128,255,0.18)');
            path.setAttribute('stroke','rgba(64,128,255,0.32)');
            path.setAttribute('stroke-width','1');
            path.style.opacity = (typeof window.__selectedIndex==='number' && window.__selectedIndex===i) ? '1' : '0';
            path.setAttribute('class','wedge');
            svg.appendChild(path);
          }
          sectors.appendChild(svg);
        }
        if (theme==='hleft' || theme==='hright'){
          try { hTray.style.display='none'; } catch {}
          try { document.getElementById('pvTopTrayWrap').style.display = 'block'; } catch {}
          const topTray = document.getElementById('pvTopTray');
          const topBg = document.getElementById('pvTopTrayBg');
          try { topTray.style.display = 'flex'; } catch {}
          const itemWidth = 56; const gap = 8; const pad = 16;
          const totalW = (N>0)? (N*itemWidth + Math.max(0,N-1)*gap + pad) : pad;
          try { topBg.style.display = 'block'; } catch {}
          try { topBg.style.width = 'auto'; } catch {}
          topTray.innerHTML = '';
          for(let i=0;i<N;i++){
            const it=items[i]; const div=document.createElement('div'); div.className='item'; const labelText=String(it.label||'').trim(); const icStr=String(it.icon||''); const useIcon = icStr.startsWith('ri-') ? `<i class="${icStr}"></i>` : `<img src="${icStr}" style="width:20px;height:20px;object-fit:contain;border-radius:4px;" />`; div.innerHTML = `${useIcon}<div class="label">${labelText}</div>`; topTray.appendChild(div)
          }
        } else {
          try { document.getElementById('pvTopTrayWrap').style.display = 'none'; } catch {}
        for (let i=0;i<N;i++){
          const it = items[i];
          const centerR = 25;
          let x = 0; let y = 0;
          if (theme==='hleft' || theme==='hright') {
            const spacing = 56;
            const startX = (theme==='hleft') ? (cx - centerR - 24) : (cx + centerR + 24);
            const dir = (theme==='hleft') ? -1 : 1;
            x = Math.round(startX + dir * i * spacing);
            y = cy;
          } else {
            const a = (Math.PI * 2) * ((i + 0.5) / Math.max(N, 1));
            const ro2 = Math.min(R + 14, Math.min(cx, cy) - 10);
            const ri2 = Math.max(centerR + 4, Math.round(R * 0.5));
            const RB = Math.round((ro2 + ri2) / 2);
            x = Math.round(cx + RB * Math.cos(a));
            y = Math.round(cy + RB * Math.sin(a));
          }
          const div = document.createElement('div');
          div.className = 'item';
          div.style.position = 'absolute';
          const halfW = (theme === 'classic') ? 28 : 22;
          const halfH = 29;
          x = Math.max(halfW, Math.min(W - halfW, x));
          y = Math.max(halfH+1, Math.min(H - (halfH+1), y));
          div.style.left = (x - halfW) + 'px';
          div.style.top = (y - halfH) + 'px';
          const labelText = String(it.label || '').trim();
          const icStr = String(it.icon||'');
          if (theme === 'classic') {
            const useIcon = icStr.startsWith('ri-')
              ? `<i class="${icStr}"></i>`
              : `<img src="${icStr}" style="width:20px;height:20px;object-fit:contain;border-radius:4px;" />`;
            div.innerHTML = `<div class="dot">${useIcon}<div class="label">${labelText}</div></div>`;
          } else {
            const useIcon = icStr.startsWith('ri-')
              ? `<i class="${icStr}"></i>`
              : `<img src="${icStr}" style="width:20px;height:20px;object-fit:contain;border-radius:4px;" />`;
            div.innerHTML = `${useIcon}<div class="label">${labelText}</div>`;
          }
          div.title = it.label || '';
          if (typeof window.__selectedIndex==='number' && window.__selectedIndex===i && theme==='classic') { div.classList.add('active'); }
          div.onclick = () => { window.__selectedIndex = i; render(); placePreview(); };
          ring.appendChild(div);
        }
        }
        const center = document.getElementById('pvCenter');
        try {
          center.style.width = (window.__centerSize || 50) + 'px';
          center.style.height = (window.__centerSize || 50) + 'px';
          const v = String(window.__centerIcon || 'ri-compass-3-line');
          const iconSize = Math.round((window.__centerSize || 50) * 0.44) + 'px';
          if (v.startsWith('ri-')) {
            if (!center.querySelector('i')) center.innerHTML = '<i class="ri-compass-3-line"></i>';
            const iEl = center.querySelector('i');
            iEl.className = v;
            iEl.style.fontSize = iconSize;
          } else {
            if (!center.querySelector('img')) center.innerHTML = '<img />';
            const img = center.querySelector('img');
            img.src = v;
            img.style.width = iconSize;
            img.style.height = iconSize;
            img.style.objectFit = 'contain';
            img.style.borderRadius = '4px';
          }
        } catch {}
        try { center.onclick = () => {}; } catch {}
      }
      function renderActionFields(it, box){
        box.innerHTML = '';
        const type = it.actionType || 'plugin';
        if (type === 'plugin'){
          const pidSel = document.createElement('select'); pidSel.className = 'sel';
          const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='选择插件'; pidSel.appendChild(emptyOpt);
          plugins.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name || p.id; pidSel.appendChild(opt); });
          pidSel.value = (it.actionPayload && it.actionPayload.pluginId) || '';
          const actSel = document.createElement('select'); actSel.className = 'sel';
          const emptyAct = document.createElement('option'); emptyAct.value=''; emptyAct.textContent='选择动作(函数)'; actSel.appendChild(emptyAct);
          const argsList = document.createElement('div'); argsList.className='arg-list';
          const addArg = document.createElement('button'); addArg.className='btn'; addArg.innerHTML = '<i class="ri-add-line"></i><span>添加参数</span>';
          const syncAll = () => { const args = Array.from(argsList.querySelectorAll('input')).map(i=>i.value.trim()).filter(s=>s.length); it.actionPayload = { pluginId: pidSel.value.trim(), fn: actSel.value.trim(), args }; };
          const buildArgs = () => {
            argsList.innerHTML = '';
            const src = Array.isArray(it.actionPayload?.args)? it.actionPayload.args : [];
            src.forEach((val, index)=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'+(index+1); inp.value=String(val||''); const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll(); }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); });
          };
          addArg.onclick = () => { const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'; const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll(); }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); };
          const updateActions = () => {
            actSel.innerHTML = ''; const emptyAct2=document.createElement('option'); emptyAct2.value=''; emptyAct2.textContent='选择动作(函数)'; actSel.appendChild(emptyAct2);
            const pid = pidSel.value.trim(); const info = pluginMap[pid]; const acts = Array.isArray(info?.actions)? info.actions : [];
            acts.forEach(a=>{ const opt=document.createElement('option'); opt.value = a.target || a.id || ''; opt.textContent = a.text || a.id || (a.target||''); actSel.appendChild(opt); });
            // 若原有 fn 不在列表，保留为选中项
            const currentFn = (it.actionPayload && it.actionPayload.fn) || '';
            if (currentFn && !Array.from(actSel.options).some(o=>o.value===currentFn)){
              const opt=document.createElement('option'); opt.value=currentFn; opt.textContent=currentFn+' (自定义)'; actSel.appendChild(opt);
            }
            actSel.value = currentFn || '';
          };
          pidSel.onchange = () => { updateActions(); syncAll(); };
          actSel.onchange = () => { syncAll(); };
          updateActions();
          buildArgs();
          box.appendChild(pidSel); box.appendChild(actSel); box.appendChild(argsList); box.appendChild(addArg);
          syncAll();
        } else if (type === 'pluginEvent'){
          const pidSel = document.createElement('select'); pidSel.className = 'sel';
          const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.textContent='选择插件'; pidSel.appendChild(emptyOpt);
          plugins.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name || p.id; pidSel.appendChild(opt); });
          pidSel.value = (it.actionPayload && it.actionPayload.pluginId) || '';
          const evtSel = document.createElement('select'); evtSel.className = 'sel';
          const emptyEvt = document.createElement('option'); emptyEvt.value=''; emptyEvt.textContent='选择事件'; evtSel.appendChild(emptyEvt);
          const argsList = document.createElement('div'); argsList.className='arg-list';
          const addArg = document.createElement('button'); addArg.className='btn'; addArg.innerHTML = '<i class="ri-add-line"></i><span>添加参数</span>';
          const syncAll = () => { const args = Array.from(argsList.querySelectorAll('input')).map(i=>i.value.trim()).filter(s=>s.length); it.actionPayload = { pluginId: pidSel.value.trim(), event: evtSel.value.trim(), args }; };
          const buildArgs = () => { argsList.innerHTML=''; const src=Array.isArray(it.actionPayload?.args)? it.actionPayload.args:[]; src.forEach((val,index)=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'+(index+1); inp.value=String(val||''); const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll(); }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); }); };
          addArg.onclick = () => { const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'; const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); syncAll(); }; inp.onchange=syncAll; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); };
          const updateEvents = async () => {
            evtSel.innerHTML = ''; const emptyEvt2=document.createElement('option'); emptyEvt2.value=''; emptyEvt2.textContent='选择事件'; evtSel.appendChild(emptyEvt2);
            const pid = pidSel.value.trim();
            try { const res = await window.lowbarAPI.pluginCall('screen.compass','listAutomationEvents',[pid]); const payload = (res && res.result) ? res.result : res; const events = Array.isArray(payload)? payload : []; events.forEach(e=>{ const opt=document.createElement('option'); opt.value=e.id || e.name; opt.textContent=e.name || e.id; evtSel.appendChild(opt); }); } catch {}
            const currentEvt = (it.actionPayload && it.actionPayload.event) || '';
            if (currentEvt && !Array.from(evtSel.options).some(o=>o.value===currentEvt)){
              const opt=document.createElement('option'); opt.value=currentEvt; opt.textContent=currentEvt+' (自定义)'; evtSel.appendChild(opt);
            }
            evtSel.value = currentEvt || '';
          };
          pidSel.onchange = () => { updateEvents(); syncAll(); };
          evtSel.onchange = () => { syncAll(); };
          buildArgs();
          box.appendChild(pidSel); box.appendChild(evtSel); box.appendChild(argsList); box.appendChild(addArg);
          updateEvents(); syncAll();
        } else if (type === 'openApp'){
          const p = document.createElement('input'); p.placeholder='程序路径'; p.value = (it.actionPayload && it.actionPayload.path) || '';
          const argsList = document.createElement('div'); argsList.className='arg-list';
          const addArg = document.createElement('button'); addArg.className='btn'; addArg.innerHTML = '<i class="ri-add-line"></i><span>添加参数</span>';
          const sync = () => { const args = Array.from(argsList.querySelectorAll('input')).map(i=>i.value.trim()).filter(s=>s.length); it.actionPayload = { path: p.value.trim(), args }; };
          const buildArgs = () => { argsList.innerHTML=''; const src=Array.isArray(it.actionPayload?.args)? it.actionPayload.args:[]; src.forEach((val,index)=>{ const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'+(index+1); inp.value=String(val||''); const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); sync(); }; inp.onchange=sync; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); }); };
          addArg.onclick = () => { const row=document.createElement('div'); row.className='arg-item'; const inp=document.createElement('input'); inp.placeholder='参数'; const rm=document.createElement('button'); rm.className='del'; rm.textContent='删除'; rm.onclick=()=>{ row.remove(); sync(); }; inp.onchange=sync; row.appendChild(inp); row.appendChild(rm); argsList.appendChild(row); };
          box.appendChild(p); box.appendChild(argsList); box.appendChild(addArg);
          p.onchange=sync; buildArgs(); sync();
        } else if (type === 'cmd'){
          const c = document.createElement('input'); c.placeholder='命令'; c.value = (it.actionPayload && it.actionPayload.cmd) || '';
          box.appendChild(c);
          const sync = () => { it.actionPayload = { cmd: c.value }; };
          c.onchange=sync;
        } else if (type === 'power'){
          const opSel = document.createElement('select'); opSel.className = 'sel';
          ['shutdown','restart','logoff'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; opSel.appendChild(opt); });
          opSel.value = (it.actionPayload && it.actionPayload.op) || 'shutdown';
          const sync = () => { it.actionPayload = { op: opSel.value }; };
          opSel.onchange = sync;
          box.appendChild(opSel);
        }
      }

      function openIconPicker(targetInput){
        const overlay = document.createElement('div');
        overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(6,12,24,0.6)'; overlay.style.backdropFilter='blur(6px)'; overlay.style.zIndex='9999'; overlay.style.padding='12px';
        const panel = document.createElement('div'); panel.style.maxHeight='80vh'; panel.style.overflow='auto'; panel.style.border='1px solid rgba(255,255,255,0.2)'; panel.style.borderRadius='8px'; panel.style.background='rgba(16,24,36,0.8)'; panel.style.padding='12px';
        const close = document.createElement('div'); close.style.textAlign='right'; close.innerHTML='<button class="btn"><i class="ri-close-line"></i><span>关闭</span></button>';
        const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fill, 120px)'; grid.style.gap='8px';
        const allIcons = Array.from(new Set([...(pluginIcons||[]), ...remixShort]));
        allIcons.forEach(ic => { const cell=document.createElement('div'); cell.style.display='flex'; cell.style.alignItems='center'; cell.style.gap='8px'; cell.style.cursor='pointer'; cell.style.padding='6px'; cell.style.border='1px solid rgba(255,255,255,0.12)'; cell.style.borderRadius='6px'; cell.innerHTML = `<i class="${ic}"></i><span style="color:#e6f0ff;font-size:12px;">${ic}</span>`; cell.onclick=()=>{ try { targetInput.value = ic; targetInput.dispatchEvent(new Event('change')); } catch {} document.body.removeChild(overlay); }; grid.appendChild(cell); });
        panel.appendChild(close); panel.appendChild(grid);
        overlay.appendChild(panel);
        document.body.appendChild(overlay);
        close.onclick = () => { try { document.body.removeChild(overlay); } catch {} };
      }

      (async function init(){
        await ensureDefaults();
        await load();
        try {
          const sc = document.getElementById('sizeCollapsedInput'); sc.value = String(window.__sizeCollapsed || 60);
          const se = document.getElementById('sizeExpandedInput'); se.value = String(window.__sizeExpanded || 240);
          const cs = document.getElementById('centerSizeInput'); cs.value = String(window.__centerSize || 50);
          const ci = document.getElementById('centerIconInput'); ci.value = String(window.__centerIcon || 'ri-compass-3-line');
          document.getElementById('pickCenterIcon').onclick = () => openIconPicker(ci);
          const stepSC = (v)=> Math.max(40, Math.min(240, v));
          const stepSE = (v)=> Math.max(120, Math.min(480, v));
          const stepCS = (v)=> Math.max(32, Math.min(160, v));
          document.getElementById('sizeCollapsedDec').onclick = () => { sc.value = String(stepSC((Number(sc.value)||60) - 5)); sc.dispatchEvent(new Event('change')); };
          document.getElementById('sizeCollapsedInc').onclick = () => { sc.value = String(stepSC((Number(sc.value)||60) + 5)); sc.dispatchEvent(new Event('change')); };
          document.getElementById('sizeExpandedDec').onclick = () => { se.value = String(stepSE((Number(se.value)||240) - 10)); se.dispatchEvent(new Event('change')); };
          document.getElementById('sizeExpandedInc').onclick = () => { se.value = String(stepSE((Number(se.value)||240) + 10)); se.dispatchEvent(new Event('change')); };
          document.getElementById('centerSizeDec').onclick = () => { cs.value = String(stepCS((Number(cs.value)||50) - 5)); cs.dispatchEvent(new Event('change')); };
          document.getElementById('centerSizeInc').onclick = () => { cs.value = String(stepCS((Number(cs.value)||50) + 5)); cs.dispatchEvent(new Event('change')); };
          sc.onchange = () => {
            window.__sizeCollapsed = Math.max(40, Math.min(240, Number(sc.value)||60));
            window.__centerSize = Math.max(32, Math.min(160, window.__sizeCollapsed - 10));
            cs.value = String(window.__centerSize);
            placePreview();
          };
          se.onchange = () => { window.__sizeExpanded = Math.max(120, Math.min(480, Number(se.value)||240)); placePreview(); };
          cs.onchange = () => {
            window.__centerSize = Math.max(32, Math.min(160, Number(cs.value)||50));
            window.__sizeCollapsed = Math.max(40, Math.min(240, window.__centerSize + 10));
            sc.value = String(window.__sizeCollapsed);
            placePreview();
          };
          ci.onchange = () => { window.__centerIcon = String(ci.value || 'ri-compass-3-line'); placePreview(); };
        } catch {}
        try {
          let list = [];
          try {
            const res = await window.lowbarAPI.pluginCall('screen.compass','listPlugins',[]);
            list = (res && res.result) ? res.result : res;
          } catch {}
          if (!Array.isArray(list) || !list.length) {
            try { const p = await window.lowbarAPI.getPlugins?.(); list = (p && p.result) ? p.result : p; } catch {}
          }
          plugins = Array.isArray(list) ? list : [];
          pluginMap = {};
          plugins.forEach(p => { pluginMap[p.id] = p; });
          pluginIcons = plugins.map(p => String(p.icon || '').trim()).filter(Boolean);
        } catch { pluginIcons = []; plugins = []; pluginMap = {}; }
        render(); placePreview();
        try { const t = await window.lowbarAPI.configGet(scope, 'theme'); const v = (t && t.result) ? t.result : t; theme = ['classic','sector','hleft','hright'].includes(v)?v:'classic'; updateThemeSeg(); } catch { theme='classic'; updateThemeSeg(); }
        placePreview();
        switchPage('project');
        try {
          const u = new URL(window.location.href);
          const channel = String(u.searchParams.get('channel')||''); channelTopic = channel;
          const caller = String(u.searchParams.get('caller')||'');
          if (window.lowbarAPI){
            window.lowbarAPI.subscribe?.(channel);
            window.lowbarAPI.onEvent?.((n,p)=>{
              if(n!==channel) return;
              if(p?.type==='update'){
                if(p.target==='centerItems'){}
                if(p.target==='switch.page'){ switchPage(String(p.value||'project')); }
                if(p.target==='apply.save'){ document.getElementById('save').click(); }
                if(p.target==='apply.add'){ document.getElementById('add').click(); }
              }
              if(p?.type==='buttons.update'){
                try {
                  if (Array.isArray(p.buttons)) { items = p.buttons; }
                  else if (p.patch && typeof p.patch.index==='number' && p.patch.item){ items[p.patch.index] = p.patch.item; }
                  if (p.theme) theme = ['classic','sector','hleft','hright'].includes(p.theme)?p.theme:theme;
                  if (typeof p.sizeCollapsed !== 'undefined') window.__sizeCollapsed = Math.max(40, Math.min(240, Number(p.sizeCollapsed)||window.__sizeCollapsed||60));
                  if (typeof p.sizeExpanded !== 'undefined') window.__sizeExpanded = Math.max(120, Math.min(480, Number(p.sizeExpanded)||window.__sizeExpanded||240));
                  if (typeof p.centerSize !== 'undefined') window.__centerSize = Math.max(32, Math.min(160, Number(p.centerSize)||window.__centerSize||50));
                  if (typeof p.centerIcon !== 'undefined') window.__centerIcon = String(p.centerIcon||window.__centerIcon||'ri-compass-3-line');
                  updateThemeSeg();
                  renderProjectList();
                  placePreview();
                } catch {}
              }
            });
          }
        } catch {}
      })();
      function switchPage(id){
        try {
          document.getElementById('paneProject').style.display = (id==='project')? 'block' : 'none';
          document.getElementById('paneTheme').style.display = (id==='theme')? 'block' : 'none';
          render();
        } catch {}
      }
    </script>
  </body>
  </html>
